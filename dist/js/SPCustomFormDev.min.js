/*! spcustomform 2017-09-14 */

function getQueryStringParam(e){for(var t,a=[],i=/\+/g,n=/([^&=]+)=?([^&]*)/g,l=function(e){return decodeURIComponent(e.replace(i," "))},d=window.location.search.substring(1);t=n.exec(d);)a[l(t[1])]=l(t[2]);return a[e]}!function(e,t,a,i){e.fn.formify=function(i){function n(e){var t,a;return e&&-1!==e.indexOf("T")?(t=e.split("T")[0],a=t.split("-"),new Date(a[0],Number(a[1]-1),Number(a[2]))):e}function l(e){var t,a,i;return e?(t=String(e.getDate()),t="0"+t,t=t.slice(-2),a=String(e.getMonth()+1),a="0"+a,a=a.slice(-2),i=e.getFullYear(),a+"/"+t+"/"+i):e}function d(e){var t="";return t+=e.getFullYear()+"-",t+=("0"+(e.getMonth()+1)).slice(-2)+"-",t+=("0"+e.getDate()).slice(-2)+"T",t+=("0"+e.getHours()).slice(-2)+":",t+=("0"+e.getMinutes()).slice(-2)+":",t+=("0"+e.getSeconds()).slice(-2)+"Z"}function r(e){var t;return-1!==e.indexOf("/")?(t=e.split("/"),new Date(t[2],Number(t[0]-1),Number(t[1]))):e}function s(t){return e.ajax({url:t,type:"GET",dataType:"json",headers:{Accept:"application/json;odata=verbose"}})}function o(t,a){return e.ajax({url:t,type:"POST",contentType:"application/json;odata=verbose",data:a,headers:{accept:"application/json;odata=verbose","X-RequestDigest":e("#__REQUESTDIGEST").val(),"IF-MATCH":"*","X-Http-Method":"MERGE"}})}function u(t,a){return e.ajax({url:t,type:"POST",contentType:"application/json;odata=verbose",data:a,headers:{accept:"application/json;odata=verbose","X-RequestDigest":e("#__REQUESTDIGEST").val()}})}function c(){var t,a=[],i=0,n=v.find(".first"),l=(n.length,[{title:"PDF",width:500},{title:(new Date).toLocaleDateString(),width:500}]),d=[],r=function(n){var l=n.attr("data-internal-fieldname");M("internalName"+l);var d=String(n.attr("data-fieldtypekind")),r=n.closest("tr").find(".second");r=v.find(".second[data-internal-fieldname='"+l+"']");if("2"===d||"4"===d){if(r.find("input").length>0)return r.find("input").val()}else if("6"===d){if(r.find("select").length>0)return r.find("select").val();if(r.find("input[type='radio']").length>0)return r.find("input[type='radio']:checked").val()}else if("3"===d){if(r.find("textarea").length>0)return r.find("textarea").val();if(r.find("span").length>0){var s=r.clone();return s.find(".no-content").remove(),t=s.find("img").each(function(){i++,e(this).after(" (SEE FIGURE "+i+") "),a.push(e(this).attr("src"))}),e.trim(e("<div>").html(s.html()).text()).replace(/[^\u0000-\u007E]/g,"")}}else if("15"===d){if(r.find("input").length>0)return r.find("input:checked").val()}else if("20"===d)return r.find(".ms-entity-resolved").length>0?r.find(".ms-entity-resolved").map(function(){return e(this).text()}).get().join(","):"";return r.text()};M("labels.le "+n.length),G(n);var s=new jsPDF;if(n.each(function(){var t=e(this).text(),a=e.trim(r(e(this)))||"";t&&t.length>35&&(t=t.substring(0,35)),M(" text:"+t+" val:"+a),d.push([t,a])}),M("data"),G(d),s.autoTable(l,d,{theme:"grid",styles:{lineWidth:.01,lineColor:0,fillStyle:"DF",valign:"middle",overflow:"linebreak"},columnStyles:{0:{columnWidth:60},1:{columnWidth:120}}}),a&&a.length>0){M(a);for(var o=0;o<a.length;o++){var u=new Image;u.crossOrigin="",u.src=a[o],u.myText=o+1,u.onload=function(){s.addPage(),s.text(15,15,"figure "+this.myText+" "),s.addImage(this,0,20),0==--i&&s.save("SPPDF.pdf")}}}else s.save("SPPDF.pdf")}var f,p,m,h,v=this,g={},y={},b="",T=e.extend({web:_spPageContextInfo.webServerRelativeUrl,displayArray:[],hiddenFields:[],lang:1033,includeControls:!0},i),x={};1036===T.lang?(x.delete="Supprimer ",x.cannotSave="Le formulaire ne peut pas être sauvegardé. <br>Les champs obligatoires suivants sont vides:",x.uploadFile="Impossible de télécharger un fichier!"):(x.delete="Delete ",x.cannotSave="Form cannot be saved.<br>The following required fields are empty:",x.uploadFile="Failed to upload a file!");var I=function(){var t=[];t.push(_spPageContextInfo.webServerRelativeUrl+"/"+_spPageContextInfo.layoutsUrl+"/iframe.aspx?"),t.push("&cal=1"),t.push("&lcid=1033"),t.push("&langid=1033"),t.push("&tz=-08:00:00.0002046"),t.push("&ww=0111110"),t.push("&fdow=0"),t.push("&fwoy=0"),t.push("&hj=0"),t.push("&swn=false"),t.push("&minjday=109207"),t.push("&maxjday=2666269"),t.push("&date="),e('[field-type="DateTime"]').each(function(a){var i=e(this).attr("id");e(this).after('<iframe id="'+i+'DatePickerFrame" title="Select a date from the calendar." style="display:none; position:absolute; width:200px; z-index:101;" src="/_layouts/15/images/blank.gif?rev=23"></iframe>'),e(this).after('<a href="#" style="vertical-align:top;"><img id="'+i+'DatePickerImage" border="0" alt="Select a date from the calendar." src="/_layouts/15/images/calendar_25.gif?rev=23"></a>'),e(this).next("a").on("click",function(){return clickDatePicker(i,t.join(""),"",event),!1})})},F=function(e,t,a,i){var n=v.find(".confirmModal");n.find(".confirmModalLabel").html(e),n.find(".confirm, .cancel").off("click"),n.find(".cancel").show(),i&&n.find(".cancel").hide(),t&&n.find(".confirm").on("click",t),a&&n.find(".cancel").on("click",a)},S=function(t,a){e.each(t,function(e,i){k(i.Title,a+"Id",t)})},k=function(t,a){a=a.substring(0,a.length-2);var i=e("[title='"+a+"']").find(".sp-peoplepicker-topLevel").attr("id"),n=SPClientPeoplePicker.SPClientPeoplePickerDict[i];n.AddUserKeys(t,!1),n.AddUnresolvedUserFromEditor(!0)},w=function(){var i,n,l;if(T.htmlData?(v.append(b+T.htmlData),l=v.find(".myForm")):i="<div class='myContainer' data-guid='"+T.listGuid+"' data-listMetadata='"+h+"'><table class='table table-hover'>",e.each(f,function(e,t){n="";var a,d=!1;T.isEditForm&&-1==T.displayArray.indexOf(t.InternalName)&&(d=!0),-1===T.hiddenFields.indexOf(t.InternalName)&&(t.Hidden||t.ReadOnlyField||12===t.FieldTypeKind)||(M("isEdit "+d+" "+t.InternalName),d&&t.SchemaXml&&(schema=t.SchemaXml,schema=schema.replace(/\\/g,""),schema=jQuery.parseXML(schema),t.jsonS=B(schema),n=O(t)),T.htmlData?(a=function(e){return 20==e||7==e||19==e?"Id":""}(t.FieldTypeKind),l.find(".first[data-internal-fieldname='"+t.InternalName+a+"']").attr("data-fieldtypekind",t.FieldTypeKind).html(t.Title+" "+(t.Required?"<span>*</span>":"")),l.find(".second[data-internal-fieldname='"+t.InternalName+a+"']").attr("data-isedit",d).html(n)):i+="<tr><td class='col-md-6 first' data-fieldTypeKind='"+t.FieldTypeKind+"' data-internal-fieldName='"+t.InternalName+"'>"+t.Title+" "+(t.Required?"<span>*</span>":"")+"</td><td class='col-md-6 second' data-internal-fieldName='"+t.InternalName+"' data-isedit='"+d+"'>"+n+"</td></tr>")}),T.includeControls){var d=T.scriptFolder+"/paperclip.png";T.htmlData?l.find(".paperclip").attr("src",d):i+="<tr><td class='col-md-6'></td><td class='col-md-6'><button type='button' class='btn btn-default testButton'>Test</button><button type='button' class='btn btn-default pdfButton'>Print to PDF</button><button type='button' class='btn btn-default saveButton'>Save</button><button type='button' class='btn btn-default saveAndExitButton'>Save and Exit</button><button type='button' class='btn btn-default cancelButton'>Cancel</button><div class='attachmentsContainer'><img class='paperclip' src='"+d+"'><input class='myAttachments' style='display:none;' type='file' fileread='run.AttachmentData' fileinfo='run.AttachmentInfo' /><div class='attachments'></div></div>"}e(t).ready(function(){M("window.location.pathname "+a.location.pathname),T.htmlData||v.append(b+i+"</table></div>"),e("#DeltaPlaceHolderPageTitleInTitleArea").find("a").eq(1).text(m.Title),R(),T.itemId?(j(),N()):U(),P(),setInterval(function(){e.ajax({url:_spPageContextInfo.webAbsoluteUrl+"/_api/contextinfo",method:"POST",headers:{Accept:"application/json; odata=verbose"},success:function(t){e("#__REQUESTDIGEST").val(t.d.GetContextWebInformation.FormDigestValue)},error:function(e,t,a){alert(a)}})},6e5),v.fadeIn()})},N=function(){var t="",a=T.scriptFolder+"/delete.png";if(p.AttachmentFiles.results&&p.AttachmentFiles.results.length>0){for(var i=0;i<p.AttachmentFiles.results.length;i++)t+="<div><a target='_blank' href='"+p.AttachmentFiles.results[i].ServerRelativeUrl+"'>"+p.AttachmentFiles.results[i].FileName+"</a><span class='deleteAttachment' style='margin-left:10px;' data-file='"+p.AttachmentFiles.results[i].FileName+"'><img src='"+a+"'></span></div>";v.find(".attachments").append(t),v.find(".attachments").on("click",".deleteAttachment",function(){F(x.delete+e(this).attr("data-file")+"?",function(){v.find(".confirmModal").modal("hide"),D(e(this))},null,!0),v.find(".confirmModal").modal("show")})}},A=function(e){return"Invalid Date"!==new Date(e)&&!isNaN(new Date(e))},_=function(t){var i={},n={},l=[],c=[],f=[],p="";v.find(".sp-peoplepicker-userSpan").each(function(){var t=e(this).attr("sid"),a=(t=t.replace("span","")).split("\\"),d=encodeURIComponent(a[0]+"\\"+a[1]),r=(e(this).closest(".customField").attr("data-internal"),e(this).closest(".customField").attr("data-kind")),o=e(this).closest(".customField").attr("data-internal");if("User"===r?i[o]=t:"UserMulti"===r&&(n[o]?n[o].push(t):n[o]=[t]),-1==l.indexOf(d)){l.push(d);var u=T.web+"/_api/web/siteusers?&$filter=LoginName%20eq%20%27"+d+"%27";c.push(s(u).done(function(e){e.d.results[0]&&f.push(e.d.results[0])}))}}),e.when.apply(e,c).done(function(){function i(e){for(var t="",a=0;a<f.length;a++)if(f[a].Title==e){t=f[a].Id;break}return t}function n(t,a,n){var l,s,o,u,c;if("single"===a)return t.find("input").val();if("number"===a)return parseFloat(t.find("input").val());if("radioButtons"===a)return t.find("input:checked").val();if("dropdown"===a)return t.find("select").val();if("dateTime"===a)return t.find("input").val()?d(r(t.find("input").val())):null;if("boolean"===a)return t.find("input").is(":checked");if("multiText"===a)return t.find("textarea").val();if("multiTextEnhanced"===a)return t.find(".DCContent").html();if("checkBoxes"===a)return l={__metadata:{type:"Collection(Edm.String)"},results:[]},t.find("input:checked").each(function(){l.results.push(e(this).val())}),l;if("lookup"==a){if("true"===t.attr("data-allowMultipleValues")){if(t.find(".multiLookup").attr("data-text"),s=t.find(".multiLookup").attr("data-id"),l={__metadata:{type:"Collection(Edm.Int32)"},results:[]},s){if(-1!=s.indexOf(";")){(o=s.split(";")).pop();for(var f=0;f<o.length;f++)o[f]=+o[f];return l.results=o,l}return l.results.push(Number(s)),l}return l}return(s=Number(t.find("select").val()))?s:null}return"multiTextEnhanced"==a?t.find("[role='textbox']").eq(1).html():"multiText"==a?t.find("textarea").val():"pplPicker"==a?(u=t.attr("data-kind"),c=t.find(".ms-entity-resolved"),"UserMulti"==u?(l={__metadata:{type:"Collection(Edm.Int32)"},results:[]},c.each(function(){id=i(e(this).attr("title")),id&&l.results.push(id)}),l):c?(id=i(c.attr("title")),id||null):null):null}var l={__metadata:{type:h}};if(v.find(".customField").each(function(){var t=e(this).attr("name"),a=e(this).attr("data-internal"),i=e(this).attr("data-required"),d=n(e(this),t);M(t+" "+a+" "+d),l[a]=d,"true"!=i||d||(p+="- "+a+"<br>")}),p)F(x.cannotSave+p,function(){v.find(".confirmModal").modal("hide")},null,!0),v.find(".confirmModal").modal("show");else{var s=T.web+"/_api/Web/Lists(guid'"+T.listGuid+"')/items";T.itemId?o(s+="("+T.itemId+")",JSON.stringify(l)).done(function(e){M("updated!"+JSON.stringify(e)+" x "+t+" "+T.goHereAfterSave),t&&T.goHereAfterSave&&(M("gon updated!"+JSON.stringify(e)+" "+t+" "+T.goHereAfterSave),a.location=T.goHereAfterSave)}).fail(function e(){M("failed to save existing item "+JSON.stringify(e))}):u(s,JSON.stringify(l)).done(function(e){if(M("created "+JSON.stringify(e)),T.itemId=e.d.Id,y&&Object.keys(y).length>0)for(var t in y)E(y[t],!0)}).fail(function(e){M("failed to save new item "+JSON.stringify(e))})}})},D=function(t){var a=t.attr("data-file");T.itemId?a&&e.ajax({url:T.web+"/_api/web/lists(guid'"+T.listGuid+"')/getItemById("+T.itemId+")/AttachmentFiles/getByFileName('"+a+"')",method:"DELETE",headers:{"X-RequestDigest":e("#__REQUESTDIGEST").val()}}).done(function(e){t.closest("div").remove()}).fail(function(e){alert("failed to delete file "+JSON.stringify(e))}):t.closest("div").remove()},E=function(i,n){(function(t){var a=e.Deferred(),i=new FileReader;return i.onload=function(e){a.resolve(e.target.result)},i.onerror=function(e){a.reject(e.target.error)},i.readAsArrayBuffer(t),a.promise()})(i).then(function(l){e.ajax({url:_spPageContextInfo.webAbsoluteUrl+"/_api/web/lists(guid'"+T.listGuid+"')/items("+T.itemId+")/AttachmentFiles/add(FileName='"+i.name+"')",method:"POST",data:l,processData:!1,headers:{Accept:"application/json; odata=verbose","content-type":"application/json; odata=verbose","X-RequestDigest":t.getElementById("__REQUESTDIGEST").value,"content-length":l.byteLength}}).done(function(e){if(n){y[i.name].uploaded=!0;var t=!0;for(var l in y)y[l].uploaded||(t=!1);t&&(M("we are done uploading all files"),a.location=T.goHereAfterSave)}else{var d="<div><a target='_blank' href='#'>"+i.name+"</a><span class='deleteAttachment'  style='margin-left:10px;' data-file='"+i.name+"'><img src='"+_spPageContextInfo.siteAbsoluteUrl+"/style library/js/test/assets/delete.png'></span></div>";v.find(".attachments").append(d),v.find(".myAttachments").hide()}}).fail(function(e){alert(x.uploadFile+JSON.stringify(e))})})},P=function(){v.find(".paperclip").on("click",function(){M("p"),v.find(".myAttachments").toggle()}),v.find(".myAttachments").on("change",function(){M(".myAttachments "+T.itemId);var t=e(this)[0].files[0],a=T.scriptFolder+"/delete.png";T.itemId?E(t):y[t.name]||(y[t.name]=t,v.find(".attachments").append('<div class="newForm" data-name="'+t.name+'"><a href="#">'+t.name+'</a><span class="deleteAttachment" data-file="'+t.name+'" style="margin-left: 10px;"><img src="'+a+'"></span></div>'))}),v.find(".saveButton").on("click",function(){_()}),v.find(".saveAndExitButton").on("click",function(){_(!0)}),v.find(".pdfButton").on("click",function(){c()}),v.find(".cancelButton").on("click",function(){a.location=T.goHereAfterSave}),v.find(".customField[name='dateTime']").find("input").on("change",function(){A(e(this).val())||e(this).val("")}),v.find(".testButton").on("click",function(){}),v.on("click",".multiLookup input",function(){var t=e(this).closest(".dropdown-menu").find("input:checked"),a=(e(this).closest(".dropdown-menu").attr("data-field"),""),i="";t.each(function(){a+=e(this).attr("data-text")+";",i+=e(this).attr("data-value")+";"}),e(this).closest(".dropdown-menu").attr("data-text",a).attr("data-id",i).closest(".second").find(".textValue").text(a)})},C=function(t,a,i,n){var l="";if("false"===i)g[n]&&(l="<select class='form-control input-sm' data-field='"+t+"'>",e.each(g[n].results,function(e,a){l+="<option data-text='"+a[t]+"' value='"+a.Id+"'>"+a[t]+"</option>"}),v.find("[data-internal='"+a+"']").html(l+="</select>"),v.find("[data-internal='"+a+"']").find("select").val(p[a]));else if(g[n]){l='<div class="button-group"><button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button><ul class="dropdown-menu multiLookup" data-field="'+a+'">',e.each(g[n].results,function(e,a){l+='<li><input type="checkbox" data-text="'+a[t]+'" data-value="'+a.Id+'">&nbsp;'+a[t]+"</input></li>"}),v.find("[data-internal='"+a+"']").html(l+="</ul></div>");var d=(p[a]||{}).results,r="";if(d&&d.length>0){for(var s=0;s<d.length;s++)v.find("[data-internal='"+a+"']").find("input[data-value='"+d[s]+"']").prop("checked",!0),r+=v.find("[data-internal='"+a+"']").find("input[data-value='"+d[s]+"']").attr("data-text")+";";v.find("[data-internal='"+a+"']").closest(".second").find(".textValue").text(r)}}},R=function(){I();var t=v.find(".ppl"),a=v.find("span[name='lookup']"),i=v.find("[name='multiTextEnhanced']");a.each(function(t,a){var i=e(this).attr("data-allowMultipleValues"),n=e(this).attr("data-lookupField"),l=e(this).attr("data-lookupList"),d=e(this).attr("data-internal");C(n,d,i,l)}),t&&ExecuteOrDelayUntilScriptLoaded(function(){t.each(function(t,a){var i=e(this).attr("id"),n=e(this).closest(".customField").attr("data-kind");q(i,n)})},"sp.js"),i&&ExecuteOrDelayUntilScriptLoaded(function(){i.each(function(){e(this).spHtmlEditor()})},"sp.js")},j=function(){var t;v.find(".second").each(function(){var a,i,d,r,s,o,u,c,f;if("true"===e(this).attr("data-isedit")){if(a=e(this).find(".customField"),i=a.attr("name"),d=a.attr("data-internal"),"pplPicker"===i&&(d=d.substring(0,d.length-2),t=a.attr("data-kind")),r=p[d])if("single"===i||"number"===i)a.find("input").val(r);else if("radioButtons"===i)a.find("input[value='"+r+"']").prop("checked",!0);else if("dropdown"===i)a.find("select").val(r);else if("dateTime"===i)a.find("input").val(l(n(r)));else if("boolean"===i)a.find("input").prop("checked",!0);else if("checkBoxes"===i){s=r.results;for(var m=0;m<s.length;m++)a.find("input[value='"+s[m]+"']").prop("checked",!0)}else"pplPicker"===i?S(r.results||[r],d):"lookup"===i?M("lookup set elsewhere"):"multiText"===i?a.find("textarea").val(r):"multiTextEnhanced"===i&&a.find(".edit-content").html(r)}else if(u=e(this).attr("data-internal-fieldName"),c=e(".first[data-internal-fieldName='"+u+"']"),2==(f=Number(c.attr("data-fieldTypeKind")))||3==f||6==f)e(this).html(p[u]);else if(4==f&&p[u])e(this).html(l(n(p[u])));else if(8==f)p[u]?e(this).html("Yes"):e(this).html("No");else if(15==f)e(this).html(p[u].results);else if((7==f||20==f)&&(r=p[u.substring(0,u.length-2)])){if(r.results){s=r.results,o="";for(var h=0;h<s.length;h++)o+=s[h].Title+"; "}else r.Title&&(o=r.Title);e(this).html(o)}})},U=function(){e("[data-default]").each(function(t,a){var i=e(this).attr("data-default");if(i){var n=e(this).attr("name");"single"===n?e(this).find("input").val(i):"radioButtons"===n?e(this).find("input[value='"+i+"']").prop("checked",!0):"dropdown"===n?e(this).find("select").val(i):"dateTime"==n?e(this).find("input").val(l(new Date)):"boolean"===n?e(this).find("input").prop("checked",!0):"checkBoxes"==n&&e(this).find("input[value='"+i+"']").prop("checked",!0)}})},q=function(e,t){var a={};a.PrincipalAccountType="User,DL,SecGroup,SPGroup",a.SearchPrincipalSource=15,a.ResolvePrincipalSource=15,a.AllowMultipleValues="User"!==t,a.MaximumEntitySuggestions=50,a.Width="100%",this.SPClientPeoplePicker_InitStandaloneControlWrapper(e,null,a)},O=function(t){var a="title='"+t.Title+"'",i="",n=t.DefaultValue||"";if(2==t.FieldTypeKind)return i+="<span class='customField' data-required='"+t.Required+"' data-kind='"+t.TypeAsString+"' data-internal='"+t.InternalName+"' data-default='"+n+"' name='single' data-Title='"+t.Title+"'><input class='form-control' type='text' "+a+"/></span>";if(3==t.FieldTypeKind)return"TRUE"==t.jsonS.Field["@attributes"].RichText?"<span data-required='"+t.Required+"' class='customField' data-kind='"+t.TypeAsString+"' data-internal='"+t.InternalName+"' data-default='"+n+"' name='multiTextEnhanced' data-Title='"+t.Title+"'><div class='ms-rtestate-field ms-rtefield ms-inputBox' id='"+t.InternalName+"Multi_"+t.Id+"_$TextField_topDiv'><div id='"+t.InternalName+"_"+t.Id+"_$TextField_inplacerte_label' style='display: none;'>Rich text editor "+t.InternalName+"</div><div class='ms-rtestate-write ms-rteflags-0 ms-rtestate-field' id='"+t.InternalName+"_"+t.Id+"_$TextField_inplacerte' role='textbox' aria-haspopup='true' aria-labelledby='"+t.InternalName+"_"+t.Id+"_$TextField_inplacerte_label' style='min-height: 84px;' contenteditable='true' aria-autocomplete='both' aria-multiline='true' RteDirty='false'><p></p></div></span>":i+="<span data-required='"+t.Required+"' class='customField' data-kind='"+t.TypeAsString+"' data-internal='"+t.InternalName+"' data-default='"+n+"' name='multiText' data-Title='"+t.Title+"'><textarea class='form-control' "+a+" /></span>";if(4==t.FieldTypeKind)return i+="<span data-required='"+t.Required+"' class='customField' data-kind='"+t.TypeAsString+"' data-internal='"+t.InternalName+"' data-default='"+n+"' name='dateTime' data-Title='"+t.Title+"'><input type='text' id='"+t.InternalName+"' field-type='DateTime' "+a+"></span>";if(6==t.FieldTypeKind)return"RadioButtons"==t.jsonS.Field["@attributes"].Format?(i+="<span data-required='"+t.Required+"' class='customField' data-kind='"+t.TypeAsString+"' data-internal='"+t.InternalName+"' data-default='"+n+"' name='radioButtons' data-Title='"+t.Title+"'><div title="+t.Title+">",e.each(t.jsonS.Field.CHOICES.CHOICE,function(e,a){i+="<div class='radio-inline'><label><input type='radio' name='"+t.Title+"' id='optionsRadios1' value='"+a["#text"]+"'>"+a["#text"]+"</label></div>"}),i+="</div></span>"):(i+="<span data-required='"+t.Required+"' class='customField' data-kind='"+t.TypeAsString+"' data-internal='"+t.InternalName+"' data-default='"+n+"' name='dropdown' data-Title='"+t.Title+"'><select title="+t.Title+" class='form-control'>",e.each(t.jsonS.Field.CHOICES.CHOICE,function(e,t){i+="<option value='"+t["#text"]+"'>"+t["#text"]+"</option>"}),i+="</select></span>"),i;if(8==t.FieldTypeKind)return i+="<span data-required='"+t.Required+"' class='customField' data-kind='"+t.TypeAsString+"' name='boolean' data-internal='"+t.InternalName+"' data-default='"+n+"' data-Title='"+t.Title+"'><div class='checkbox'><label><input type='checkbox' "+a+"/></label></div></span>";if(9==t.FieldTypeKind)return i+="<span class='customField' data-required='"+t.Required+"' data-kind='"+t.TypeAsString+"' data-internal='"+t.InternalName+"' data-default='"+n+"' name='number' data-Title='"+t.Title+"'><input class='form-control' type='number' "+a+" "+L(t.MaximumValue,t.MinimumValue)+"/></span>";if(15==t.FieldTypeKind)return i+="<span data-required='"+t.Required+"' class='customField' data-kind='"+t.TypeAsString+"' name='checkBoxes' data-internal='"+t.InternalName+"' data-default='"+n+"' data-Title='"+t.Title+"'><div title='"+t.Title+"' class='checkBoxes'>",e.each(t.jsonS.Field.CHOICES.CHOICE,function(e,t){i+="<div class='checkbox-inline'><label><input type='checkbox' value='"+t["#text"]+"'>"+t["#text"]+"</label></div>"}),i+="</div></span>";if(20==t.FieldTypeKind)return i+="<span data-required='"+t.Required+"' class='customField' data-kind='"+t.TypeAsString+"' data-internal='"+t.InternalName+"Id'  name='pplPicker' data-Title='"+t.Title+"'><div id='"+t.Title+"' class='ppl' "+a+" /></span>";if(7==t.FieldTypeKind){var l=t.LookupList;return l=l.substring(1,l.length-1),i+="<span data-required='"+t.Required+"' class='customField' data-kind='"+t.TypeAsString+"' data-internal='"+t.InternalName+"Id'  name='lookup' class='lookup' data-lookupList='"+l+"' data-lookupField='"+t.LookupField+"' data-allowMultipleValues='"+t.AllowMultipleValues+"' data-Title='"+t.Title+"'><div id='"+t.Title+"'  /></span><span class='textValue'></span>"}return""},L=function(e,t){var a=Number(e),i=Number(t);return a<1e12&&i>-1e12?"max='"+a+"' min='"+i+"'":""},B=function(e){var t={};if(1==e.nodeType){if(e.attributes.length>0){t["@attributes"]={};for(var a=0;a<e.attributes.length;a++){var i=e.attributes.item(a);t["@attributes"][i.nodeName]=i.nodeValue}}}else 3==e.nodeType&&(t=e.nodeValue);if(e.hasChildNodes())for(var n=0;n<e.childNodes.length;n++){var l=e.childNodes.item(n),d=l.nodeName;if(void 0===t[d])t[d]=B(l);else{if(void 0===t[d].push){var r=t[d];t[d]=[],t[d].push(r)}t[d].push(B(l))}}return t},M=function(e){_spPageContextInfo.userId===T.adminId&&console.log(e)},G=function(e){_spPageContextInfo.userId===T.adminId&&console.dir(e)},H=function(){var t=T.web+"/_api/web/Lists(guid'"+T.listGuid+"')/Fields",a=T.web+"/_api/web/Lists(guid'"+T.listGuid+"')/Views?&$filter=DefaultView%20eq%20true",i=T.web+"/_api/web/Lists(guid'"+T.listGuid+"')",n=T.scriptFolder+"modal.html",l=[],d=T.web+"/_api/web/Lists(guid'"+T.listGuid+"')/";T.itemId&&(d+="items("+T.itemId+")"),T.htmlUrl&&l.push(e.get(T.htmlUrl).done(function(e){T.htmlData=e}).fail(function(e){M("we failed to get the html "+JSON.stringify(e))})),l.push(e.get(n).done(function(e){b=e}).fail(function(e){M("we failed to get the html "+JSON.stringify(e))})),s(t).done(function(t){f=t.d.results;var n="",r="";T.itemId&&(n="&$select=*,AttachmentFiles,",r="&$expand=AttachmentFiles,"),e.each(f,function(t,a){if(!(a.Hidden||a.ReadOnlyField||7!=a.FieldTypeKind&&20!=a.FieldTypeKind)&&(T.itemId&&20==a.FieldTypeKind&&(n+=a.InternalName+"/Title,"+a.InternalName+"/Id,",r+=a.InternalName+"/Id,"),7==a.FieldTypeKind&&(T.itemId&&(n+=a.InternalName+"/"+a.LookupField+","+a.InternalName+"/Id,",r+=a.InternalName+"/Id,"),T.isEditForm))){var i=a.LookupList;i=i.substring(1,i.length-1),l.push(e.ajax({url:T.web+"/_api/web/Lists(guid'"+i+"')/items?&$top=5000&$select=Id,"+a.LookupField,type:"GET",listGuid:i,dataType:"json",headers:{Accept:"application/json;odata=verbose"},success:function(e){g[this.listGuid]=e.d},fail:function(e){M("fail list lookup "+this.listGuid+" "+JSON.stringify(e))}}))}}),n&&T.itemId&&(n=n.substring(0,n.length-1),r=r.substring(0,r.length-1),d+="?"+n+r),l.push(s(d).done(function(e){M("list done"),p=e.d,G(p),T.itemId?h=p.__metadata.type:(p=e.d,h=p.ListItemEntityTypeFullName)}).fail(function(e){M("fail fieldData"),G(e)})),l.push(s(a).done(function(e){T.goHereAfterSave=e.d.results[0].ServerRelativeUrl,M("view url "+e.d.results[0].ServerRelativeUrl)}).fail(function(e){M("fail viewUlr"),G(e)})),l.push(s(i).done(function(e){m=e.d,M("listData"),G(e.d)}).fail(function(e){M("fail viewUlr"),G(e)})),e.when.apply(e,l).then(function(){M("deferred done lookupListData"),G(g),w()}).fail(function(){M("we failed in first apply")})}).fail(function(e){M("fail fieldData"),G(e)})};T.scriptFolder&&T.listGuid?function(){var a,i=e("head");e("#getCustomForm").attr("src").split("getCustomForm")[0];T.cssUrl&&i.append('<link rel="stylesheet" href="'+T.cssUrl+'" type="text/css" />'),T.jsUrl&&i.append('<script src="'+T.jsUrl+'"/><\/script>'),a=setInterval(function(){/loaded|complete/.test(t.readyState)&&(clearInterval(a),H())},10)}():alert("You need to supply the script folder and a list guid")}}(jQuery,document,window);